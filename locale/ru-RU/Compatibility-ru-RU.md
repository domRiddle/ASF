# Совместимость

ASF - это приложение C#, работающее на платформе .NET Core. Это значит, что ASF не компилируется напрямую в **[машинный код](https://ru.wikipedia.org/wiki/%D0%9C%D0%B0%D1%88%D0%B8%D0%BD%D0%BD%D1%8B%D0%B9_%D0%BA%D0%BE%D0%B4)**, который исполняется на вашем ЦП, а компилируется в код **[CIL](https://ru.wikipedia.org/wiki/Common_Intermediate_Language)**, которому для работы требуется CIL-совместимая среда выполнения.

Этот подход даёт гигантское количество преимуществ, поскольку CIL платформо-независим, и поэтому ASF может запускаться на множестве доступных ОС, в частности Windows, Linux и OS X. Для этого не только не требуется эмуляция, но даже поддерживаются оптимизации под конкретную аппаратуру, такие как наборы инструкций SSE. Благодаря этому, ASF может достигать превосходной производительности и оптимальности, и при этом оставаться прекрасно совместимым и надёжным.

Это также означает что ASF не имеет **особых требований к ОС**, поскольку всё что он требует это работающую **среду выполнения** на этой ОС, а не саму ОС. Пока среда выполнения корректно исполняет код ASF, совершенно не важно, происходит ли это под ОС Windows, Linux, OS X, BSD, Sony Playstaion 4, Nintendo Wii или на вашем тостере - если под него существует**[.NET Core](https://github.com/dotnet/core-setup#daily-builds)**, на нём будет работать и **[ASF](https://github.com/JustArchi/ArchiSteamFarm/releases/latest)**.

Однако, независимо от того, на чём вы запускаете ASF, вы должны убедиться что на вашей платформе установлены все **[предусловия для работы .NET Core](https://github.com/dotnet/core/blob/master/Documentation/prereqs.md)**. Это низкоуровневые библиотеки, необходимые для функционирования среды выполнения и ядра ASF. Вполне возможно, что некоторые (или даже все) из них у вас уже установлены.

* * *

## Пакеты ASF

ASF поставляется в 2 основных вариациях - универсальный пакет и пакеты под конкретные ОС. С точки зрения функциональности они идентичны, и способны автоматически обновляться. Единственная разница в том, содержится ли там только **универсальный (generic)** пакет, или с ним поставляется среда выполнения **под конкретную ОС**.

* * *

### Универсальный пакет

Универсальный (`generic`) пакет это платформо-независимая сборка, не включающая себя никакого машинно-ориентированного кода. Этот вариант требует чтобы в вашей ОС уже была установлена среда выполнения .NET Core **требуемой версии**. Все мы знаем как сложно бывает поддерживать все зависимости в актуальном состоянии, поэтому этот пакет предназначен в основном для людей, которые **уже используют** .NET Core и не хотят дублировать среду выполнения только для ASF, если можно использовать ту, которая уже установлена. Универсальный пакет также позволяет запустить ASF **на любой платформе, для которой вы можете получить работающую реализацию среды выполнения .NET Core**, независимо от того, существует ли сборка ASF под данную ОС, или нет.

Не рекомендуется использовать универсальный пакет если вы начинающий или даже продвинутый пользователь, желающий просто запустить ASF и не вдаваться в технические подробности, связанные с .NET Core. Другими словами - если вы знаете что это, можете пользоваться, иначе вам лучше взять пакет под конкретную ОС, как описано ниже.

#### Пакет для .NET Framework

В дополнение к универсальному пакету, описанному выше, существует также пакет `generic-netf` основанный на .NET Framework (а не на .NET Core). Этот пакет - устаревшая версия и оставлен для поддержки совместимости со времён ASF версии 2.x.x.x, и может быть запущен, например, с помощью **[Mono](https://www.mono-project.com)**, чего пакет `generic`, основанный на .NET Core, на данный момент не позволяет.

В основном вам следует **по возможности избегать использования этого пакета**, поскольку большинство операционных систем прекрасно (и гораздо лучше) работают с пакетом `generic`, упомянутым выше. Фактически, этот пакет имеет смысл использовать только на платформах, под которые отсутствует работоспособная реализация среды выполнения .NET Core, но при этом имеется работающая реализация Mono. Примером такой платформы может служить `linux-x86`, для которого на сегодняшний день отсутствует работоспособная реализация среды выполнения .NET Core.

Поскольку со временем к всё больше платформ будет поддерживаться .NET Core и всё меньше будет совместимость между .NET Framework и .NET Core, пакет `generic-netf` будет полностью заменён пакетом `generic` когда-нибудь в будущем. Пожалуйста, воздержитесь от использования этого пакета если вы можете вместо этого использовать любой пакет, основанный на .NET Core, поскольку в `generic-netf` отсутствует многое из функционала доступного в версиях на .NET Core, и со временем этого функционала будет становиться всё меньше. Мы оказываем поддержку этого пакета только на машинах, на которых невозможно использовать вариант `generic`, описанный выше (например, `linux-x86`), и только с актуальной средой выполнения (например, последней версией Mono).

* * *

### Пакеты под конкретные ОС

Пакеты под конкретную ОС, помимо управляемого кода, присутствующего в универсальном пакете, также включают в себя машинный код для заданной платформы. Другими словами, в пакете под конкретную ОС **уже присутствует среда выполнения .NET Core**, что позволяет вам полностью избежать проблем с установкой и перейти непосредственно к запуску ASF. Пакет под конкретную ОС, как понятно из названия, подходит только для одной ОС, и для каждой ОС нужна своя версия - например для Windows требуется исполняемый файл `ArchiSteamFarm.exe` формата PE32+, а для Linux исполняемый файл `ArchiSteamFarm` формата Unix ELF. Как вы возможно знаете, эти два типа несовместимы между собой.

ASF на данный момент доступно для следующих вариантов ОС:

- `win-x64` работает на 64-разрядных ОС Windows. Это включает в себя Windows 7 (SP1+), 8.1, 10, Server 2008 R2 (SP1+), 2012, 2012 R2, 2016, а также будущие версии.
- `linux-arm` работает на 32-разрядных ОС Linux для процессоров на базе ARM (ARMv7+). Это включает в себя в особенности Raspberry Pi 2 & 3 и все основанные на glibc ОС Linux доступные для них, как текущие так и будущие версии. Этот вариант не будет работать с более старой архитектурой ARM, такой как ARMv6 которую можно встретить на Raspberry Pi 0 & 1.
- `linux-x64` работает на 64-разрядных ОС Linux на базе glibc. Это включает в себя Alpine, CentOS/Fedora/RHEL, Debian/Ubuntu/Linux Mint, OpenSUSE/SLES и многие другие, включая их производные, текущих и будущих версий.
- `win-x64` работает на 64-разрядных ОС OS X. Это включает в себя 10.12, а также будущие версии.

Разумеется, даже если под ваше сочетание ОС и архитектуры отсутствует готовый пакет, вы вы всегда можете самостоятельно установить подходящую среду выполнения .NET Core и запустить универсальный пакет ASF (`generic`), это и есть основная причина почему он существует. Универсальный пакет ASF платформо-независим и будет работать на любой платформе, на которой есть работоспособная среда выполнения .NET Core. Важно отметить - ASF требуется среда выполнения .NET Core, а не конкретная ОС или архитектура. Например, если вы пользуетесь 32-разрядной версией Windows, то несмотря на то что нет отдельной версии ASF `win-x86`, вы всё равно можете установить .NET Core SDK версии `win-x86` и без проблем запустить универсальный ASF. Мы просто не можем создать пакеты под все сочетания ОС-архитектура которые могут использоваться, поэтому приходится чем-то ограничиться. x86 не попадает в это ограничение, поскольку это устаревшая архитектура как минимум с 2004 года.

Для просмотра полного списка поддерживаемых .NET Core 2.1 платформ и ОС, посетите раздел "**[release notes](https://github.com/dotnet/core/blob/master/release-notes/2.1/2.1-supported-os.md)**" в репозитории .NET Core.

* * *

## Требования среды выполнения

Если вы используете пакет под конкретную ОС, то вам не нужно беспокоиться о требуемой среде выполнения, поскольку ASF всегда комплектуется требуемой и актуальной средой исполнения, главное чтобы у вас были установлены актуальные **[предусловия для .NET Core](https://github.com/dotnet/core/blob/master/Documentation/prereqs.md)**. Другими словами, **вам не нужно устанавливать среду выполнения или SDK для .NET Core**, поскольку пакеты под конкретную ОС требуют только присутствия необходимых библиотек в данной ОС (предусловий) и ничего более.

Однако, если вы пытаетесь запустить **универсальный (generic)** пакет ASF - вам следует убедиться, что среда .NET Core поддерживает необходимую ASF платформу.

ASF в данный момент основано на **.NET Core 2.1** (`netcoreapp2.1`), но в будущем может потребоваться более новая платформа. `netcoreapp2.1` поддерживается начиная с версии 2.1.300 SDK (среда выполнения 2.1.0), но мы рекомендуем использовать **[последнюю версию SDK](https://www.microsoft.com/net/download)** доступную для вашей машины.

Если сомневаетесь - проверьте что использует наша **[система непрерывной интеграции](https://ci.appveyor.com/project/JustArchi/ArchiSteamFarm)** для компиляции и развертывания сборок ASF на GitHub. Вы найдёте вывод команды `dotnet --info` наверху каждой сборки.

* * *

## Проблемы и решения

### Обновление Debian Jessie

Если вы обновились с Debian 8 Jessie (или более старого) на Debian 9 Stretch, убедитесь что у вас **нет** пакета `libssl1.0.0`, например командой `apt-get purge libssl1.0.0`. В противном случае, вы можете столкнутся с ошибкой сегментации. Это устаревший пакет, и он отсутствует и недоступен для установки в чистом Debian 9, и единственный путь столкнуться с такой проблемой - это обновление с Debian 8 или более старого - **[dotnet/corefx #8951](https://github.com/dotnet/corefx/issues/8951#issuecomment-314455190)**. Если у вас есть пакеты, зависящие от этой устаревшей версии libssl, вам следует либо обновить их, либо избавиться от них - не только из-за этой проблемы, но в первую очередь потому что они основаны на устаревшей библиотеке.

### Неверные сертификаты с ASF V3.2+

Под Linux вы можете столкнуться со специфичной проблемой связанной с сертификатами SSL доступными на вашей машине. Это проявляется в виде следующей ошибки:

```csharp
System.Net.Http.HttpRequestException: The SSL connection could not be established, see inner exception. ---> Interop+Crypto+OpenSslCryptographicException: error:2006D002:BIO routines:BIO_new_file:system lib
   at Interop.Crypto.CheckValidOpenSslHandle(SafeHandle handle)
```

Проблема скорее всего связана с тем, что некоторые из сертификатов недоступны для чтения. Это может быть из-за недостаточных привилегий (в качестве проверки вы можете попробовать запустить ASF под пользователем `root`) или из-за других проблем с неверными файлами сертификатов.

Текущий способ обойти эту проблему зависит от причины. На чистой установке (например Debian), это никогда не должно произойти, поскольку в хранилище не будет неверных/конфиденциальных сертификатов, поэтому проблема касается только людей, у которых есть другие сертификаты для личного использования (например VPN или веб-сайты) которые ASF не может прочитать. Вам следует обдумать и либо выдать соответствующие привилегию пользователю, под которым запускается ASF (как например убедиться что все SSL сертификаты в `/etc/pki` и `/etc/ssl` имеют глобальное разрешение на чтение как минимум `644`), либо запускать ASF под пользователем `root`, либо переместить конфиденциальные сертификаты куда-нибудь где ASF не будет пытаться прочитать их на этапе инициализации.

Эта проблема должна быть решена в версии .NET Core 2.1.1, поэтому описанные выше способы обхода в ближайшем будущем больше не потребуются.

Ссылка: **[dotnet/corefx #29942](https://github.com/dotnet/corefx/issues/29942)**.

### Среда выполнения .NET Core загружает неправильную библиотеку `libcurl.so`

Если у вас в системе установлены одновременно `libcurl.so.3` и `libcurl.so.4` .NET Core может решить загрузить вторую, что приведёт к падению ASF при попытке инициализировать клиент http.

```csharp
OnUnhandledException() System.TypeInitializationException: The type initializer for 'System.Net.Http.CurlHandler' threw an exception. ---> System.TypeInitializationException: The type initializer for 'Http' threw an exception. ---> System.TypeInitializationException: The type initializer for 'HttpInitializer' threw an exception. ---> System.DllNotFoundException: Unable to load DLL 'System.Net.Http.Native': The specified module or one of its dependencies could not be found.
```

Если вы столкнулись с такой проблемой, вам может понадобиться вручную указать среде выполнения .NET Core правильную библиотеку для загрузки. Найдите в своей системе `libcurl.so.3` и добавьте её в `LD_PRELOAD` перед запуском ASF:

```shell
LD_PRELOAD=/usr/lib/libcurl.so.3 ./ArchiSteamFarm
```

Это должно помочь решить эту проблему, если ваша библиотека `libcurl.so.3` работает нормально.