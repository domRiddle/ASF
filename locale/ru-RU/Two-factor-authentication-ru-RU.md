# Двухфакторная аутентификация

Steam использует двухфакторную систему аутентификации, известную как "Escrow", которая требует дополнительных сведений для различных действий, связанных с аккаунтом. Вы можете прочесть об этом подробнее **[тут](https://help.steampowered.com/faqs/view/2E6E-A02C-5581-8904)** и **[тут](https://help.steampowered.com/faqs/view/34A1-EA3F-83ED-54AB)**. Далее в тексте будем называть 2ФА систему и наше решение, которое интегрируется с ней - ASF 2FA.

---

# Логика работы ASF

Независимо от того, используете ли вы ASF 2FA или нет, ASF включает в себя всю нужную логику и способен определять учетные записи, защищенные стандартом 2ФА. У вас будут запрашивать необходимые данные когда они нужны (как например при входе). Тем не менее эти запросы могут быть автоматизированы с помощью 2ФА ASF, которая будет автоматически генерировать необходимые токены, освобождая вас от лишних действий и добавляя дополнительную функциональность (описано ниже).

---

# ASF 2FA

ASF 2FA это встроенный модуль, отвечающий за реализацию функций 2ФА для ASF, таких, как генерация кодов и принятие подтверждений. Он работает путем дублирования ваших существующих данных аутентификации, так что вы можете использовать ваш текущий аутентификатор и ASF 2FA одновременно.

Вы можете проверить, используется ли на боте ASF 2FA путём исполнения **[команд](https://github.com/JustArchiNET/ArchiSteamFarm/wiki/Commands-ru-RU)** `2fa`. Если вы ещё не импортировали ваш аутентификатор в ASF 2FA, команды `2fa` не будут работать, а это означает что ваш аккаунт не использует ASF 2FA, и, следовательно, не может использовать некоторые расширенные функций ASF, которым этот модуль требуется для работы.

---

## Creation

In general we strongly recommend to **[duplicate](#import)** your existing authenticator, as after all, that's the main purpose ASF 2FA was designed for. However, ASF comes with official `MobileAuthenticator` **[plugin](https://github.com/JustArchiNET/ArchiSteamFarm/wiki/Plugins)** which further extends ASF 2FA allowing you to link completely new authenticator as well. This can be useful in case you're unable or unwilling to use other tools and you do not mind ASF 2FA to become your main (and maybe only) authenticator.

In order to assign new 2FA and automatically import it as ASF 2FA, you should do the following steps:

1. Create ASF bot for the target account, start it and log in, which you probably already did.
2. Assign working and operative phone number to the account used by the bot **[here](https://store.steampowered.com/phone/manage)**. Phone number is absolutely required, there is no way to add 2FA without it.
3. Execute `2fainit [Bot]` command, replacing `[Bot]` with your bot's name.

Assuming you got a successful reply, the following two things have happened:

- A new `<Bot>.maFile.PENDING` file was generated by ASF in your `config` directory.
- SMS was sent from Steam to the phone number you have assigned for the account above.

The authenticator details are not operative yet, however, you can review the generated file if you'd like to. If you want to be double safe, you can for example already write down revocation code.

4. Once satisfied, execute `2fafinalize [Bot] <ActivationCode>` command, replacing `[Bot]` with your bot's name and `<ActivationCode>` with the code you've received through SMS.

Assuming everything worked properly, previously generated `<Bot>.maFile.PENDING` file was renamed to `<Bot>.maFile.NEW`. This indicates that your 2FA credentials are now valid and active. We recommend you to create a copy of that file and keep it in **secure and safe location**. In addition to that, we recommend you to open it (it's a text file) and write down `revocation_code` which will allow you, as the name implies, to revoke the authenticator in case you lose it.

In regards to technical details, the generated `maFile` includes all details that we have received from Steam server during linking authenticator, and in addition to that `device_id` field which may be needed for other authenticators. The file follows and is fully compatible with **[SDA](#steamdesktopauthenticator)** for import.

ASF automatically imports your authenticator once the procedure is done, therefore `2fa` and other related commands should now be operative for the bot account you linked the authenticator to.

---

## Импорт

Import process requires already linked and operational authenticator that is supported by ASF. В настоящее время ASF поддерживает несколько различных официальных и неофициальных источников 2FA - Android, iOS, SteamDesktopAuthenticator и WinAuth, а также ручной метод, который позволяет вам самостоятельно предоставить необходимые учетные данные. Если у вас еще нет аутентификатора, вам необходимо выбрать одно из доступных приложений и настроить его. Если у вас нет предпочтений, какое из них использовать, мы рекомендуем WinAuth, но работать будет любое из них, если конечно вы будете следовать инструкциям.

Все последующие руководства требуют чтобы у вас уже был **настроенный и работающий** аутентификатор в одном из заданных приложений. 2ФА ASF не будет работать если вы импортируете неверные данные, поэтому убедитесь что аутентификатор правильно работает перед тем как его импортировать. Это включает в себя тестирование и проверку того, что следующие функции аутентифиатора работают правильно:
- Вы можете генерировать коды для входа и эти коды принимаются сетью Steam
- Вы можете получить список операций, требующих подтверждения, и они отображаются в вашем мобильном аутентификаторе
- Вы можете подтверждать эти операции, и они правильно отображаются сетью Steam как подтверждённые/отклонённые

Убедитесь что ваш аутентификатор работает проверив, работают ли функции описанные выше - если нет, то они не будут работать и в ASF, и вы просто зря потратите время и получите лишние проблемы.

---

### Android-смартфон

**Приведенные ниже инструкции относятся к приложению Steam версии `2.X`, в настоящее время нет ресурсов по извлечению необходимых данных, начиная с версии `3.0`. Мы будем обновлять этот раздел сразу же, как только будет найден общедоступный метод. На сегодняшний день обходным решением является намеренная установка старой версии приложения Steam, регистрация 2FA и извлечение необходимых данных, после чего можно обновить приложение до последней версии - существующий аутентификатор продолжит работать.**

В общем случае для импорта аутентификатора с телефона Android вам потребуется **[root](https://en.wikipedia.org/wiki/Rooting_(Android_OS))**доступ. Рутинг отличается на разных устройствах, поэтому мы не можем сказать вам как получить root на вашем устройстве. Посетите **[форум 4PDA](https://4pda.ru/forum/)** и найдите руководство для вашего устройства, а также общую о получении root-доступа. Если вы не смогли найти там руководство для вашего устройства, попробуйте поискать в google.

Официально невозможно получить доступ к защищённым файлам Steam без помощи root. Единственный официальный метод без root получения файлов Steam это создание незашифрованного бекапа папки `/data` тем или иным способом, и получение необходимых файлов вручную на ПК, но поскольку это сильно зависит от производителя вашего телефона и **не** является стандартным для Android, мы не будем рассматривать здесь этот вариант. Если вам повезло иметь такую возможность, вы можете ей воспользоваться, но у большинства пользователей ничего подобного не будет.

По неофициальным данным, извлечь необходимые файлы можно без root-доступа, установив или понизив версию приложения Steam до версии `2.1` (или более ранней), настроив мобильный аутентификатор и создав снимок приложения (вместе с файлами `data`, которые нам нужны) через `adb backup`. Однако, поскольку это ведёт к серьёзным проблемам с безопасностью и является совершенно неподдерживаемым, мы не будем развивать эту тему, Valve устранило эту дыру в безопасности в более новых версиях не просто так, и мы упомянули об этом только чтобы вы знали о такой возможности. Тем не менее, возможно, удастся выполнить чистую установку этой версии, связать новый аутентификатор, извлечь необходимые файлы, а затем обновить приложение, чего будет достаточно, но в любом случае вы сами справитесь с этим методом.

Если вы успешно получили root-доступ на вашем телефоне, то теперь вам понадобиться скачать любой root-проводник доступный в Play Маркет, такой как **[этот](https://play.google.com/store/apps/details?id=com.jrummy.root.browserfree)** (или любой другой на ваш вкус, на самом деле). Вы также можете получить доступ к защищённым файлам через ADB (Android Debug Bridge) или любым другим доступным для вас методом, мы сделаем это через проводник поскольку это самый дружелюбный к пользователю способ.

Откройте ваш root-проводник и перейдите в папку `/data/data`. Помните что папкаа `/data/data` является защищённой и вы не сможете получить к ней доступ без root-прав. Когда перейдёте туда, найдите папку `com.valvesoftware.android.steam.community`, и скопируйте её в папку `/sdcard`, которая указывает на ваше встроенное внутреннее хранилище. После этого, у вас должно получиться подключить ваш телефон к ПК и скопировать эту папку из внутреннего хранилища как обычно. Если по какой-то причине папка не будет видна, хотя вы уверены что скопированы её в правильное место, попробуйте сначала перезагрузить свой телефон.

Теперь вы можете выбрать, хотите ли вы импортировать ваш аутентификатор сначала в WinAuth, а затем в ASF, или в ASF напрямую. Первый вариант проще и позволит вам продублировать аутентификатор также на вашем ПК, позволив вам подтверждать операции и создавать коды в 3 разных местах - на телефоне, на ПК и через ASF. Если вы хотите этого, просто откройте WinAuth, добавьте новый аутентификатор Steam и выберите пункт импорта из Android, затем следуйте инструкциям выбрав файлы которые вы получили выше. После окончания, вы можете импортировать аутентификатор из WinAuth в ASF, как описано в разделе, посвященном WinAuth, ниже.

Если вы не хотите или вам не нужно проходить через WinAuth, то просто скопируйте файл `files/Steamguard-<SteamID>` из нашего защищенного каталога, где `SteamID` - это ваш 64-битный идентификатор Steam аккаунта, который вы хотите добавить (если их несколько, потому что если у вас только один аккаунт, то это будет единственный файл). Вам нужно разместить этот файл в каталоге `config` вашего ASF. Как только вы это сделаете - переименуйте этот файл в `BotName.maFile`, где `BotName` - имя вашего бота, для которого вы добавляете 2ФА ASF. После этого шага запустите ASF - он должен обнаружить файл с расширением `.maFile` и импортировать его.

```text
[*] INFO: ImportAuthenticator() <1> Конвертация .maFile в формат ASF...
[*] INFO: ImportAuthenticator() <1> Мобильный аутентификатор успешно импортирован!
```

На этом всё, если вы импортировали правильный файл с корректными данными, всё должно работать правильно, вы можете это проверить использовав команды `2fa`. Если вы где-то ошиблись, вы всегда можете удалить `Bot.db` и начать всё с начала.

---

### iOS

Для iOS вам понадобится **[ios-steamguard-extractor](https://github.com/CaitSith2/ios-steamguard-extractor)**. Это возможно благодаря тому, что вы можете сделать нешифрованную резервную копию, скопировать её на ПК и использовать эту утилиту чтобы извлечь данные Steam, которые нельзя получить иным образом (во всяком случае без jailbreak, из-за шифрования iOS).

Перейдите к **[последней версии](https://github.com/CaitSith2/ios-steamguard-extractor/releases/latest)** и скачайте программу. После того, как вы извлекли нужные данные, вы можете например импортировать их в WinAuth, а затем из WinAuth в ASF (хотя вы можете просто скопировать json-часть начиная с `{` и заканчивая `}` в файл `BotName.maFile` и продолжать как обычно). Если вы спросите меня - я настоятельно рекомендую сначала импортировать в WinAuth и убедиться что и создание кодов и подтверждение операций работают правильно, чтобы знать всё ли хорошо. Если ваши учетные данные неверные, 2ФА ASF будет работать неправильно, поэтому лучше делать импорт в ASF в последнюю очередь.

Для вопросов и сообщения о проблемах перейдите в раздел **[issues](https://github.com/CaitSith2/ios-steamguard-extractor/issues)**.

*Помните, что эта утилита неофициальная, и вы пользуетесь ею на свой страх и риск. Мы не предоставляем технической поддержки если это не работает - нам несколько раз сообщали что могут быть экспортированы неверные данные 2ФА - поэтому проверьте что в правильно работает подтверждение операций в чём-то типа WinAuth прежде чем импортировать данные в ASF!*

---

### SteamDesktopAuthenticator

Если у вас уже есть аутентифицатор, работающий в SDA, вы можете заметить что у вас уже есть файл `steamID.maFile` в папке `maFiles`. Убедитесь, что этот `.maFile` находится в незашифрованном виде, поскольку ASF не умеет расшифровывать файлы SDA: незашифрованный файл должен начинаться с символа `{` и заканчиваться на  `}`. При необходимости вы можете сначала удалить шифрование из настроек SDA и включить его снова, когда закончите. Как только файл будет в расшифрованном виде, скопируйте его в папку `config` ASF.

Теперь вы можете переименовать `steamID.maFile` в `BotName.maFile` в папке config ASF, где `BotName` - это имя вашего бота, в который вы добавляете ASF 2FA. Вы можете оставить всё как есть, ASF обнаружит этот файл автоматически после входа в Steam. Переименование файла помогает ASF, сделав возможным использование ASF 2FA перед входом, если вы этого не сделаете, затем файл может быть выбран только после успешного входа ASF (так как ASF не знает `steamID` вашей учетной записи до фактического входа).

Если вы всё сделали правильно, запустите ASF, вы должны увидеть:

```text
[*] INFO: ImportAuthenticator() <1> Конвертация .maFile в формат ASF...
[*] INFO: ImportAuthenticator() <1> Мобильный аутентификатор успешно импортирован!
```

С этого момента ваш 2ФА ASF должен быть работоспособен на этом аккаунте.

---

### WinAuth

Сначала создайте новый пустой файл `BotName.maFile` в папке `config` вашего ASF, где `BotName` это имя вашего бота, для которого вы хотите добавить 2ФА ASF. Помните, что имя должно быть `BotName.maFile` а НЕ `BotName.maFile.txt`, Windows по-умолчанию скрывает расширения для зарегистрированных типов файлов. Если имя файла будет неверным, ASF не обнаружит его.

Теперь запустите WinAuth как обычно. Кликните правой кнопкой мыши на иконке Steam и выберите "Show SteamGuard and Recovery Code". Поставьте отметку в поле "Allow copy". Вы должны увидеть уже знакомую вам JSON-структуру в нижней части окна, начинающуюся с `{`. Скопируйте весь текст в файл `BotName.maFile`, созданный на предыдущем этапе.

Если вы всё сделали правильно, запустите ASF, вы должны увидеть:

```text
[*] INFO: ImportAuthenticator() <1> Конвертация .maFile в формат ASF...
[*] INFO: ImportAuthenticator() <1> Мобильный аутентификатор успешно импортирован!
```

С этого момента ваш 2ФА ASF должен быть работоспособен на этом аккаунте.

---

## Готово

С этого момента все команды `2fa` будут работать как будто на вашем обычном устройстве 2ФА. Вы можете использовать одновременно 2ФА ASF и ваш аутентификатор (Android, iOS, SDA или WinAuth) для генерации кодов и подтверждения операций.

Если у вас есть аутентификатор на телефоне, вы можете по желанию удалить SteamDesktopAuthenticator и/или WinAuth, поскольку он вам больше не понадобится. Однако я советую оставить его просто на всякий случай, даже не говоря о том что пользоваться им гораздо удобнее чем обычным аутентификатором Steam. Just keep in mind that ASF 2FA is **NOT** a general purpose authenticator, it doesn't include all data that authenticator should have, but limited subset of original `maFile`. It's not possible to convert ASF 2FA back to original authenticator, therefore always make sure that you have general-purpose authenticator or `maFile` in other place, such as in WinAuth/SDA, or on your phone.

---

## ЧАВО

### Как ASF использует модуль 2ФА?

Если 2ФА ASF настроена, ASF будет автоматически подтверждать все обмены которые отправляет/получает ASF. Также будет возможно автоматически при необходимости создавать коды 2FA, например чтобы выполнить вход. В добавок к этому, наличие 2ФА ASF делает доступными команды `2fa` для вашего удобства. Это должно быть всё, если я ничего не забыл - проще говоря, ASF использует модуль 2ФА по мере необходимости.

---

### Что если мне нужен код 2ФА?

Вам нужен код 2ФА для любого аккаунта, защищённого 2ФА, это также включает в себя каждый аккаунт с 2ФА ASF. Вам стоит создавать коды в аутентификаторе, который вы использовали для импорта, но вы можете также создавать временные коды с помощью команды `2fa`, отправив её через чат выбранному боту. Вы также можете использовать команду `2fa <BotNames>` чтобы сгенерировать временные коды для указанных ботов. Этого должно быть достаточно чтобы получить доступ к ботам через, например, браузер, но как я отметил выше - вам стоит использовать вместо этого более удобный аутентификатор (Android, iOS, SDA или WinAuth).

---

### Могу ли я пользоваться своим обычным аутентификатором после импорта в 2ФА ASF?

Да, ваш аутентификатор останется полностью работоспособным и вы можете использовать его одновременно с 2ФА ASF. В этом смысл всего процесса - мы импортируем данные вашего аутентификатора в ASF, чтобы ASF мог использовать их и подтверждать операции обмена, нужные вам.

---

### Где в ASF хранится мобильный аутентификатор?

Мобильный аутентификатор в ASF хранится в файле `BotName.db`, в вашей папке `config`, вместе с другой важной информацией относящейся к аккаунту. Если вы хотите удалить 2ФА ASF, читайте инструкцию ниже.

---

### Как удалить ASF 2FA?

Просто остановите ASF и удалите файл `BotName.db` соответствующий боту 2ФА ASF которого вы хотите удалить. Это удалит импортированный 2ФА, привязанный к ASF, но НЕ отвяжет аутентификатор от аккаунта. Если вместо этого вы хотите отвязать свой аутентификатор, то кроме удаления его из ASF (сначала), вам нужно отключить его в том аутентификаторе, которым вы пользуетесь (Android, iOS, SDA или WinAuth), или - если по какой-то причине вы не можете, использовать код восстановления, который вы получили при подключении аутентификатора, на сайте Steam. Невозможно удалить аутентификатор с помощью ASF, для этого вам надо использовать аутентификатор общего назначения, который у вас уже есть.

---

### Я подключил аутентификатор через SDA/WinAuth, а затем импортировал его в ASF. Можно мне теперь отключить его и заново подключить к своему телефону?

**Нет**. ASF **импортирует** данные вашего аутентификатора чтобы им пользоваться. Если вы отключите аутентификатор, то 2ФА ASF перестанет работать, не зависимо от того, удалили вы его как сказано выше, или нет. Если вы хотите использовать аутентификатор одновременно на телефоне и в ASF (плюс возможно в SDA/WinAuth), то вам нужно **импортировать** аутентификатор с вашего телефона, а не создавать новый в SDA/WinAuth. У вас может быть подключен только **один** аутентификатор, поэтому ASF **импортирует** этот аутентификатор со всеми данными для использования в 2ФА ASF - это **тот же самый** аутентификатор, просто существующий в двух местах. Если вы решите отключить ваш мобильный аутентификатор - не важно каким способом - 2ФА ASF перестанет работать, поскольку скопированный ранее аутентификатор будет уже неверным. Чтобы использовать 2ФА ASF вместе с аутентификатором на телефоне, вы должны импортировать его с Android/iOS, как описано выше.

---

### Лучше ли использовать для подтверждения всех операций 2ФА ASF по сравнению с WinAuth/SDA/Другим аутентификатором?

**Да**, по ряду причин. Первое, и самое главное - использование 2ФА ASF **значительно** увеличивает безопасность, поскольку модуль 2ФА в ASF будет следить чтобы ASF подтверждал автоматически только собственные обмены, так что даже если атакующий попытается запросить обмен, который вреден для вас, 2ФА ASF **не** примет такой обмен, поскольку он не был создан с помощью ASF. В добавок к безопасности, использование 2ФА ASF также даёт преимущества в производительности и оптимальности, поскольку 2ФА ASF подтверждает обмены сразу после того как они созданы, и только тогда, в противоположность поиску неподтвержденных операций каждые X минут как сделано например в SDA или WinAuth. Короче говоря, нет причин использовать сторонний аутентификатор если вы хотите автоматически подтверждать обмены, созданные ASF - именно для этого создана 2ФА ASF, и её использование никак не мешает вам подтверждать всё остальное в своём любимом аутентификаторе. Мы настоятельно рекомендуем использовать 2ФА ASF для всех действий ASF - это гораздо безопаснее чем прочие решения.

---

## Дополнительные настройки

Если вы продвинутый пользователь, вы можете также создать maFile вручную. Это может быть использовано, если вы хотите импортировать аутентификатор из иных источников чем те, что описаны выше. Он должен иметь **[корректную JSON структуру](https://jsonlint.com)**, состоящую из:

```json
{
  "shared_secret": "STRING",
  "identity_secret": "STRING"
}
```

В стандартных аутентификаторах имеется больше параметров - они полностью игнорируются ASF в процессе импорта, поскольку нам они не нужны. Вам не нужно их удалять - ASF требуется только корректная структура JSON с 2 обязательными полями, указанными выше, а все остальные поля (если они есть) - игнорируются. Разумеется, вам нужно заменить `STRING` в этом примере на корректные для вашего аккаунта значения. Каждая `STRING` должна быть base64-кодированным представлением байт, из которой сделан соответствующий приватный ключ.